<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUNI Bid-Wanted Trading Support</title>
    <!-- 
        NOTE: The Tailwind CSS CDN is used for rapid prototyping. 
        For production, it's recommended to install Tailwind CSS as a PostCSS plugin.
        See: https://tailwindcss.com/docs/installation
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    
    <style>
        /* Tooltip styles for explainability */
        .explain-tooltip {
            position: absolute;
            display: none;
            background-color: #1e293b; /* slate-800 */
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            z-index: 10;
            width: max-content;
            max-width: 350px; /* Constrain width to prevent overflow */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 1px solid #334155; /* slate-700 */
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 4px; /* Space between icon and tooltip */
            text-align: left; /* Ensure text is left-aligned */
        }
        .explain-tooltip.tooltip-right {
            left: auto;
            right: 0;
            transform: none;
        }
        .has-tooltip:hover .explain-tooltip {
            display: block;
        }
        .ag-header-cell-label {
            justify-content: center;
        }
        .ag-theme-alpine-dark .ag-cell {
            font-size: 12px;
            padding: 2px 4px;
        }
        .ag-theme-alpine-dark .ag-header-cell-label {
            font-size: 13px;
            font-weight: 600;
        }
        .ag-theme-alpine-dark .ag-row {
            height: 28px !important;
        }
        .ag-theme-alpine-dark {
             --ag-header-height: 30px !important;
        }
        /* Additional styles for toggle and animations */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6; /* blue-500 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6; /* blue-500 */
        }
        @keyframes fade-in-right {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-fade-in-right { animation: fade-in-right 0.5s ease-out forwards; }
        
        @keyframes fade-out-right {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        .animate-fade-out-right { animation: fade-out-right 0.3s ease-in forwards; }
        .tab-btn {
            padding: 0.5rem 1rem;
            cursor: pointer;
            background-color: transparent;
            border: none;
            color: #94a3b8; /* slate-400 */
            border-bottom: 2px solid transparent;
            font-size: 14px;
        }
        .tab-btn.active {
            color: #f1f5f9; /* slate-100 */
            border-bottom-color: #3b82f6; /* blue-500 */
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 antialiased font-sans text-sm">

    <div id="app-container" class="container mx-auto p-3">
        
        <header class="mb-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-slate-100">MUNI Bid-Wanted</h1>
                <p class="text-xs text-slate-400">Trading Decision Support</p>
            </div>
             <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <label for="hide-risky-toggle" class="mr-2 font-medium text-slate-400 text-xs">Hide Risky</label>
                    <div class="relative inline-block w-8 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="hide-risky-toggle" id="hide-risky-toggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-2 appearance-none cursor-pointer"/>
                        <label for="hide-risky-toggle" class="toggle-label block overflow-hidden h-4 rounded-full bg-slate-700 cursor-pointer"></label>
                    </div>
                </div>
            </div>
        </header>

        <div id="main-view">
            <!-- Tab Navigation -->
            <div class="flex border-b border-slate-700">
                <button id="triage-tab" class="tab-btn active">Triage</button>
                <button id="screened-tab" class="tab-btn hidden">Screened Items</button>
            </div>

            <!-- Tab Content -->
            <div id="tab-content" class="mt-3">
        <!-- Triage Grid View -->
                <div id="triage-view" class="tab-pane">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-lg font-semibold text-slate-200">Triage Grid</h2>
                    </div>
                    <div id="triage-grid" class="ag-theme-quartz-dark" style="height: 520px; width: 100%;"></div>
                </div>

                <!-- Screened Items View (hidden by default) -->
                <div id="screened-view" class="tab-pane hidden">
                    <p class="text-xs text-slate-300 mb-2 bg-yellow-900/50 border-l-2 border-yellow-500 text-yellow-300 p-2 rounded-md">
                        Showing items hidden from the main grid. A "High Risk" item is defined as meeting any of the following:
                        <span class="font-mono block mt-1">Illiquid Flag = true <b>OR</b> Neg. News Prob &gt; 15% <b>OR</b> Concentrated Own. = true <b>OR</b> 1D OAS Widening &gt; 5bps</span>
                    </p>
                    <div id="screened-grid" class="ag-theme-quartz-dark" style="height: 480px; width: 100%;"></div>
                </div>
            </div>
        </div>


        <!-- Detailed Instrument View (hidden by default) -->
        <div id="detail-view" class="hidden">
            <button id="back-to-triage" class="mb-3 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-1 px-3 rounded transition duration-200 text-xs">
                &larr; Back to Grids
            </button>
            
            <div id="instrument-details" class="space-y-4">
                <!-- Header -->
                <div class="p-3 bg-slate-800 rounded-md border border-slate-700">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 id="detail-issuer-name" class="text-xl font-bold text-slate-100"></h2>
                            <p id="detail-cusip" class="text-base text-slate-400 font-mono"></p>
                        </div>
                        <div class="text-right flex items-center space-x-4">
                            <div id="action-buttons" class="flex space-x-2">
                                <!-- Buttons will be injected here -->
                            </div>
                            <div id="detail-market-regime-container" class="text-right relative">
                                <!-- Market Regime injected here -->
                            </div>
                            <div>
                                <p class="text-xs text-slate-400">Rating</p>
                                <p id="detail-rating" class="text-xl font-mono px-2 py-0.5 bg-blue-900/50 text-blue-300 rounded border border-blue-800"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Value Assessment -->
                    <div id="value-assessment-panel" class="p-3 bg-slate-800 rounded-md border border-slate-700 space-y-2">
                        <h3 class="text-base font-semibold text-slate-200 border-b border-slate-600 pb-1 mb-2">Value Assessment</h3>
                        <div class="flex justify-between text-xs"><span>Current OAS:</span><span id="detail-current-oas" class="font-semibold font-mono"></span></div>
                        <div class="flex justify-between text-xs"><span>Spread vs Peers:</span><span id="detail-vs-peers" class="font-semibold font-mono"></span></div>
                        <div class="flex justify-between text-xs"><span>Spread vs MMD:</span><span id="detail-vs-mmd" class="font-semibold font-mono"></span></div>
                        <div class="flex justify-between text-xs"><span>Spread vs UST:</span><span id="detail-vs-ust" class="font-semibold font-mono"></span></div>
                        <div id="detail-credit-spread-1d" class="explain-container relative text-xs"></div>
                        <div id="detail-credit-spread-5d" class="explain-container relative text-xs"></div>
                    </div>

                    <!-- Liquidity Assessment -->
                    <div class="p-3 bg-slate-800 rounded-md border border-slate-700 space-y-2">
                        <h3 class="text-base font-semibold text-slate-200 border-b border-slate-600 pb-1 mb-2">Liquidity Assessment</h3>
                        <div class="flex justify-between items-center text-xs">
                            <span>Composite Score:</span>
                            <span id="detail-liquidity-score" class="font-semibold text-base font-mono"></span>
                        </div>
                         <div class="flex justify-between items-center text-xs">
                            <span>Is Concentrated:</span>
                            <span id="detail-is-concentrated" class="font-semibold text-base font-mono"></span>
                        </div>
                        <div id="detail-bid-ask-5d" class="explain-container relative text-xs"></div>
                        <div>
                            <h4 class="font-semibold text-slate-400 mt-3 text-xs">Trade History (Volume / Dealers)</h4>
                            <div class="flex justify-between text-xs"><span>Last 1 Day:</span><span id="detail-trade-1d" class="font-semibold font-mono"></span></div>
                            <div class="flex justify-between text-xs"><span>Last 5 Days:</span><span id="detail-trade-5d" class="font-semibold font-mono"></span></div>
                        </div>
                    </div>

                    <!-- Idiosyncratic & Downside Risk -->
                    <div class="p-3 bg-red-900/20 border-l-2 border-red-500 rounded-r-md border border-slate-700 space-y-2">
                        <h3 class="text-base font-semibold text-red-400 border-b border-red-500/30 pb-1 mb-2">Idiosyncratic & Downside Risk</h3>
                        <div id="detail-news-sentiment" class="explain-container relative text-xs"></div>
                        <div id="detail-neg-news-5d" class="explain-container relative text-xs"></div>
                        <div id="detail-downside-1d" class="explain-container relative text-xs"></div>
                        <div id="detail-downside-5d" class="explain-container relative text-xs"></div>
                    </div>
                </div>

                <!-- Valuation Intelligence -->
                <div class="p-3 bg-slate-800 rounded-md border border-slate-700 space-y-3">
                     <h3 class="text-base font-semibold text-slate-200 border-b border-slate-600 pb-1">Valuation Intelligence</h3>
                     
                     <div class="flex items-center space-x-2" id="scenario-buttons">
                        <span class="text-xs text-slate-400 mr-2">Scenarios:</span>
                        <!-- Scenario buttons injected here -->
                     </div>

                     <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
                        <!-- Weight Sliders -->
                        <div class="space-y-3" id="weight-sliders">
                            <p class="text-xs text-slate-400">Adjust forecast weights to influence suggested price:</p>
                            <!-- Sliders will be injected here -->
                        </div>
                        <!-- Results -->
                        <div class="bg-slate-900/50 p-3 rounded-md flex flex-col items-center justify-center text-center">
                            <p class="text-xs text-slate-400">System-Suggested Price</p>
                            <div class="relative group mt-1">
                                <input type="text" id="suggested-price-input" class="text-2xl font-mono font-bold text-green-400 bg-transparent border-b-2 border-slate-700 text-center w-36 focus:ring-0 focus:border-blue-500 focus:bg-slate-800 rounded-sm transition duration-200 ease-in-out">
                                <div class="absolute -right-5 top-0 bottom-0 flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                                </div>
                            </div>
                            <p id="suggested-price-explanation" class="text-xs text-slate-300 mt-1"></p>
                            <div id="valuation-action-buttons" class="mt-3 flex space-x-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" class="fixed top-5 right-5 z-50 w-full max-w-sm space-y-3"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- MOCK DATA ---
            function generateCusip() {
                // Not a valid CUSIP, but good enough for a mock.
                return (Math.random().toString(36).substring(2, 7) + Math.random().toString(36).substring(2, 6)).toUpperCase();
            }

            function createMockData() {
                const data = [];
                const issuers = ['State of California', 'New York City TFA', 'Commonwealth of Massachusetts', 'State of Texas', 'Chicago Board of Education'];
                const regimes = ['Bull_Steepener', 'Bear_Flattener', 'Bear_Steepener', 'Bull_Flattener', 'Recession_Easing', 'Idiosyncratic_Distress'];
                
                const regimeDrivers = {
                    'Bull_Steepener': [
                        { feature: 'yield_curve_slope_10y2y', attribution: '+1.2 Z' },
                        { feature: 'investment_grade_credit_spread', attribution: '-1.1 Z' },
                        { feature: 'vix_index', attribution: '-0.9 Z' },
                    ],
                    'Bear_Flattener': [
                        { feature: 'yield_curve_slope_10y2y', attribution: '-1.3 Z' },
                        { feature: 'move_index', attribution: '+1.1 Z' },
                    ],
                     'Bear_Steepener': [
                        { feature: 'yield_curve_slope_10y2y', attribution: '+1.1 Z' },
                        { feature: 'tips_breakeven_5y', attribution: '+1.4 Z' },
                        { feature: 'vix_index', attribution: '+1.0 Z' },
                    ],
                    'Bull_Flattener': [
                        { feature: 'yield_curve_slope_10y2y', attribution: '-1.0 Z' },
                        { feature: 'high_yield_credit_spread', attribution: '+1.2 Z' },
                         { feature: 'vix_index', attribution: '+1.3 Z' },
                    ],
                    'Recession_Easing': [
                        { feature: 'yield_curve_slope_10y2y', attribution: '-1.6 Z' },
                        { feature: 'high_yield_credit_spread', attribution: '+1.8 Z' },
                        { feature: 'move_index', attribution: '+1.5 Z' },
                    ],
                    'Idiosyncratic_Distress': [
                        { feature: 'mmd_ust_ratio_10y', attribution: '+1.9 Z' },
                        { feature: 'muni_fund_flows_net', attribution: '-1.7 Z' },
                        { feature: 'HY Spread vs Muni Spread', attribution: '-1.5 Z Divergence' },
                    ]
                };

                for (let i = 0; i < 15; i++) {
                    const cusip = generateCusip();
                    const current_oas = 50 + Math.random() * 50;
                    const price = parseFloat((98 + Math.random() * 4).toFixed(3));
                    const change_bps_1d = (Math.random() * 10 - 5);
                    const forecast_1d_oas = current_oas + change_bps_1d;
                    const regime = regimes[Math.floor(Math.random() * regimes.length)];

                    data.push({
                        cusip: cusip,
                        security_details: {
                            issuer_name: issuers[i % issuers.length],
                            rating: ['AAA', 'AA+', 'AA', 'A+', 'A'][Math.floor(Math.random() * 5)],
                            price: price
                        },
                        liquidity: {
                            is_illiquid_flag: Math.random() > 0.8,
                            composite_score: (Math.random() * 100).toFixed(2),
                        },
                        ownership: {
                            is_concentrated_flag: Math.random() > 0.7,
                        },
                        market_context: {
                            regime: regime,
                            regime_drivers: regimeDrivers[regime],
                        },
                        news_sentiment: {
                            score: (Math.random() * 2 - 1).toFixed(2),
                            top_articles: [
                                { headline: 'Issuer Announces Plans for New Infrastructure Projects', source: 'Local News Wire' },
                                { headline: 'State Pension Fund Reports Stable Outlook', source: 'Financial Times' },
                                { headline: 'Regional Economic Growth Exceeds Expectations', source: 'Economic Bulletin' },
                            ]
                        },
                        bid_wanted_details: {
                            side: 'BWIC',
                            price: price.toFixed(3),
                            size: [10, 25, 50, 100, 250][Math.floor(Math.random() * 5)] * 1000,
                        },
                        calculated_risk_metrics: {
                            option_adjusted_spread_bps: current_oas.toFixed(2),
                            modified_duration: (Math.random() * 5 + 2).toFixed(2),
                        },
                        forecasted_oas_change_1d_bps: change_bps_1d.toFixed(2),
                        forecasted_values: {
                            '1-day': {
                                bid_ask_spread_pct: (Math.random() * 0.5).toFixed(4),
                                probability_negative_news_pct: (Math.random() * 20).toFixed(2),
                                credit_spread_oas_bps: forecast_1d_oas.toFixed(2),
                                downside_price_volatility: { value: (Math.random() * 1.5).toFixed(2) },
                            },
                            '5-day': {
                                bid_ask_spread_pct: (Math.random() * 0.7).toFixed(4),
                                probability_negative_news_pct: (Math.random() * 30).toFixed(2),
                                credit_spread_oas_bps: (current_oas + (Math.random() * 40 - 18)).toFixed(2),
                                downside_price_volatility: { value: (Math.random() * 2.5).toFixed(2) },
                            },
                            '20-day': {
                                credit_spread_oas_bps: (current_oas + (Math.random() * 60 - 25)).toFixed(2),
                            }
                        },
                        relative_value: {
                            vs_peers_bps: (Math.random() * 20 - 10).toFixed(2),
                            vs_mmd_bps: (Math.random() * 30 + 5).toFixed(2),
                            vs_ust_bps: (Math.random() * 150 + 50).toFixed(2),
                        },
                        trade_history_summary: {
                            't1d': { total_par_volume: Math.floor(Math.random() * 5000000), unique_dealer_count: Math.floor(Math.random() * 5) + 1 },
                            't5d': { total_par_volume: Math.floor(Math.random() * 25000000), unique_dealer_count: Math.floor(Math.random() * 10) + 2 },
                        },
                        forecast_explainability: {
                             'forecasted_oas_change_1d_bps': {
                                feature_attributions: [
                                    { feature: 'UST 10Y Yield Curve', attribution: (Math.random() * -5).toFixed(1) },
                                    { feature: 'Similar Sector Spread Change', attribution: (Math.random() * -3).toFixed(1) },
                                    { feature: 'State GOV Deficit Change', attribution: (Math.random() * 2).toFixed(1) }
                                ]
                            },
                            '1-day.credit_spread_oas_bps': {
                                feature_attributions: [
                                    { feature: 'UST 10Y Yield', attribution: (Math.random() * 0.5).toFixed(2) },
                                    { feature: 'Market Volatility', attribution: (Math.random() * 0.3).toFixed(2) },
                                    { feature: 'Issuer Rating Change', attribution: (Math.random() * 0.2).toFixed(2) }
                                ]
                            },
                             '5-day.probability_negative_news_pct': {
                                feature_attributions: [
                                    { feature: 'News Sentiment Score', attribution: (Math.random() * 0.6).toFixed(2) },
                                    { feature: 'Similar Bond Price Action', attribution: (Math.random() * 0.4).toFixed(2) }
                                ]
                            },
                             '5-day.bid_ask_spread_pct': {
                                feature_attributions: [
                                     { feature: 'Recent Trade Volume', attribution: (Math.random() * -0.4).toFixed(2) },
                                     { feature: 'Dealer Inventory Levels', attribution: (Math.random() * 0.2).toFixed(2) }
                                ]
                            },
                            '20-day.credit_spread_oas_bps': {
                                feature_attributions: [
                                    { feature: 'FOMC Rate Decision Probability', attribution: (Math.random() * 0.7).toFixed(2) },
                                    { feature: '3M Inflation Swap', attribution: (Math.random() * 0.3).toFixed(2) }
                                ]
                            },
                             '1-day.downside_price_volatility.value': {
                                feature_attributions: [
                                     { feature: 'MOVE Index', attribution: (Math.random() * 0.8).toFixed(2) },
                                     { feature: 'High Yield Spread Change', attribution: (Math.random() * 0.5).toFixed(2) }
                                ]
                            },
                        }
                    });
                }
                return data;
            }

            const mockRowData = createMockData();

            // --- AG GRID SETUP ---
            const columnDefs = [
                { headerName: "CUSIP", field: "cusip", width: 120, sortable: true, filter: true },
                { headerName: "Issuer", field: "security_details.issuer_name", sortable: true, filter: true, flex: 2 },
                { headerName: "Rating", field: "security_details.rating", width: 100, sortable: true, filter: true },
                { 
                    headerName: "Illiquid", field: "liquidity.is_illiquid_flag", width: 100, sortable: true, filter: true,
                    cellClassRules: {
                        'bg-yellow-200 text-yellow-800': params => params.value === true,
                    },
                    cellRenderer: params => params.value ? 'Yes' : 'No'
                },
                { 
                    headerName: "1D Bid/Ask %", field: "forecasted_values.1-day.bid_ask_spread_pct", width: 150, sortable: true, filter: 'agNumberColumnFilter',
                    valueFormatter: params => parseFloat(params.value).toFixed(4)
                },
                { 
                    headerName: "Neg. News Prob %", field: "forecasted_values.1-day.probability_negative_news_pct", width: 180, sortable: true, filter: 'agNumberColumnFilter',
                    cellClassRules: {
                        'bg-red-200 text-red-800': params => Number(params.value) > 15,
                    },
                    valueFormatter: params => parseFloat(params.value).toFixed(2)
                },
                { headerName: "RV vs Peers (bps)", field: "relative_value.vs_peers_bps", width: 180, sortable: true, filter: 'agNumberColumnFilter',
                  valueFormatter: params => parseFloat(params.value).toFixed(2)
                },
                { 
                    headerName: "1D OAS Δ (bps)", field: "forecasted_oas_change_1d_bps", width: 160, sortable: true, filter: 'agNumberColumnFilter',
                    cellClassRules: {
                        'bg-red-200 text-red-800': params => Number(params.value) > 5,
                        'bg-green-200 text-green-800': params => Number(params.value) < -5
                    },
                  valueFormatter: params => parseFloat(params.value).toFixed(2)
                },
            ];

            let triageGridApi;
            let screenedGridApi;
            let allRowData = [];
            let isRiskyFilterActive = false;

            function onGridsReady() {
                // This function is called by each grid's onGridReady event.
                // We proceed only when both grid APIs are available.
                if (triageGridApi && screenedGridApi) {
                    allRowData = createMockData();
                    triageGridApi.setGridOption('rowData', allRowData);
                    checkForOpportunities(allRowData.slice(0, 5)); // Check for initial opportunities
                    startDataStream();
                }
            }

            const gridOptions = {
                columnDefs: columnDefs,
                rowData: null, // Set data dynamically
                pagination: true,
                paginationPageSize: 50,
                onRowClicked: onRowClicked,
                domLayout: 'autoHeight',
                rowHeight: 28,
                headerHeight: 30,
                theme: 'ag-theme-quartz-dark',
                getRowId: params => params.data.cusip,
                onGridReady: (params) => {
                    triageGridApi = params.api;
                    onGridsReady();
                },
                 rowClassRules: {
                    'bg-green-100/10 animate-pulse': params => params.data.is_new === true,
                }
            };
             const screenedGridOptions = {
                columnDefs: columnDefs,
                rowData: [],
                onRowClicked: onRowClicked,
                domLayout: 'autoHeight',
                rowHeight: 28,
                headerHeight: 30,
                theme: 'ag-theme-quartz-dark',
                getRowId: params => params.data.cusip,
                onGridReady: (params) => {
                    screenedGridApi = params.api;
                    onGridsReady();
                },
            };

            const gridDiv = document.querySelector('#triage-grid');
            agGrid.createGrid(gridDiv, gridOptions);

            const screenedGridDiv = document.querySelector('#screened-grid');
            agGrid.createGrid(screenedGridDiv, screenedGridOptions);


            // --- UI LOGIC ---
            const mainView = document.querySelector('#main-view');
            const detailView = document.querySelector('#detail-view');
            const backButton = document.querySelector('#back-to-triage');
            const hideRiskyToggle = document.querySelector('#hide-risky-toggle');
            
            // Tab elements
            const triageTab = document.querySelector('#triage-tab');
            const screenedTab = document.querySelector('#screened-tab');
            const tabPanes = document.querySelectorAll('.tab-pane');

            function showTab(tabId) {
                tabPanes.forEach(pane => {
                    if (pane.id === tabId) {
                        pane.classList.remove('hidden');
                    } else {
                        pane.classList.add('hidden');
                    }
                });

                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.id === `${tabId.split('-')[0]}-tab`) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            triageTab.addEventListener('click', () => showTab('triage-view'));
            screenedTab.addEventListener('click', () => showTab('screened-view'));

            function isRowRisky(row) {
                return row.liquidity.is_illiquid_flag === true ||
                       Number(row.forecasted_values['1-day'].probability_negative_news_pct) > 15 ||
                       row.ownership.is_concentrated_flag === true ||
                       Number(row.forecasted_oas_change_1d_bps) > 5;
            }

            function onRowClicked(event) {
                const data = event.data;
                populateDetailView(data);
                mainView.classList.add('hidden');
                detailView.classList.remove('hidden');
            }

            backButton.addEventListener('click', () => {
                detailView.classList.add('hidden');
                mainView.classList.remove('hidden');
            });
            
            hideRiskyToggle.addEventListener('change', (event) => {
                if (!triageGridApi || !screenedGridApi) return;
                isRiskyFilterActive = event.target.checked;

                // Transactional filtering logic
                if (isRiskyFilterActive) {
                    screenedTab.classList.remove('hidden');
                    const rowsToMove = [];
                    triageGridApi.forEachNode(node => {
                        if (isRowRisky(node.data)) {
                            rowsToMove.push(node.data);
                        }
                    });
                    if(rowsToMove.length > 0) {
                        triageGridApi.applyTransaction({ remove: rowsToMove });
                        screenedGridApi.applyTransaction({ add: rowsToMove });
                    }
                } else {
                    screenedTab.classList.add('hidden');
                    showTab('triage-view'); // Switch back to triage tab if filter is disabled
                    const rowsToMove = [];
                    screenedGridApi.forEachNode(node => rowsToMove.push(node.data));
                    if (rowsToMove.length > 0) {
                        screenedGridApi.applyTransaction({ remove: rowsToMove });
                        triageGridApi.applyTransaction({ add: rowsToMove });
                    }
                }
            });

            function startDataStream() {
                let nextLowRiskTime = Date.now() + 60000; // Schedule first low-risk for 1 minute from now

                setInterval(() => {
                    const currentTime = Date.now();
                    let newData;

                    if (currentTime >= nextLowRiskTime) {
                        // Time to generate a low-risk / high-conviction bid
                        newData = createMockData()[0]; // Start with a random base
                        newData.is_new = true;
                        newData.liquidity.is_illiquid_flag = false;
                        newData.ownership.is_concentrated_flag = false; // Ensure this is not risky
                        newData.forecasted_values['1-day'].probability_negative_news_pct = (Math.random() * 4).toFixed(2); // < 5
                        
                        // Correctly derive the change to ensure data consistency
                        const change_bps = -(Math.random() * 10 + 6); // e.g., -12.5
                        const current_oas = parseFloat(newData.calculated_risk_metrics.option_adjusted_spread_bps);
                        const new_forecast_oas = current_oas + change_bps;

                        newData.forecasted_oas_change_1d_bps = change_bps.toFixed(2);
                        newData.forecasted_values['1-day'].credit_spread_oas_bps = new_forecast_oas.toFixed(2);

                        // Set the next time for a low-risk bid
                        nextLowRiskTime = currentTime + 60000; // 1 minute
                    } else {
                        // Generate a standard, random bid
                        newData = createMockData()[0];
                        newData.is_new = true;
                    }

                    allRowData.unshift(newData);
                    
                    if (!isRowRisky(newData)) {
                        // It's NOT risky, so it ALWAYS goes to the main triage grid.
                        triageGridApi.applyTransaction({ add: [newData] });
                        // And ONLY non-risky items are checked for opportunities.
                        checkForOpportunities([newData]);
                    } else {
                        // It IS risky. Add it to the correct grid based on the filter state.
                        if (isRiskyFilterActive) {
                            screenedGridApi.applyTransaction({ add: [newData] });
                        } else {
                            triageGridApi.applyTransaction({ add: [newData] });
                        }
                    }

                    setTimeout(() => {
                        if (!triageGridApi || !screenedGridApi) return;
                        
                        let rowNode = triageGridApi.getRowNode(newData.cusip);
                        let targetApi = triageGridApi;

                        if (!rowNode) {
                            rowNode = screenedGridApi.getRowNode(newData.cusip);
                            targetApi = screenedGridApi;
                        }
                        
                        if (rowNode) {
                            const updatedData = { ...rowNode.data };
                            delete updatedData.is_new;
                            targetApi.applyTransaction({ update: [updatedData] });
                        }
                    }, 5000);

                }, 30000); // Add a new bid every 30 seconds
            }

            function handleAction(type, size, price) {
                createSubmissionAlert(`Your ${type} for ${size} @ ${price} has been submitted.`);
                detailView.classList.add('hidden');
                mainView.classList.remove('hidden');
            }

            function createSubmissionAlert(message) {
                const alertContainer = document.getElementById('alert-container');
                const alertId = `alert-submit-${Date.now()}`;

                const alertEl = document.createElement('div');
                alertEl.id = alertId;
                alertEl.className = 'bg-slate-700 border border-slate-600 rounded-md shadow-lg p-3 animate-fade-in-right flex items-center space-x-3';
                alertEl.innerHTML = `
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-slate-100">${message}</p>
                    </div>
                `;

                alertContainer.appendChild(alertEl);

                setTimeout(() => {
                    alertEl.classList.add('animate-fade-out-right');
                    setTimeout(() => alertEl.remove(), 300);
                }, 3000); // Remove after 3 seconds
            }

            function populateDetailView(data) {
                // Helper to safely access nested properties
                const get = (p, o) => p.reduce((xs, x) => (xs && xs[x]) ? xs[x] : null, o);
                
                // Header
                document.getElementById('detail-issuer-name').textContent = get(['security_details', 'issuer_name'], data);
                document.getElementById('detail-cusip').textContent = `CUSIP: ${get(['cusip'], data)}`;
                document.getElementById('detail-rating').textContent = get(['security_details', 'rating'], data);

                // Action Buttons
                const actionContainer = document.getElementById('action-buttons');
                actionContainer.innerHTML = ''; // This section is now empty, buttons moved to valuation.

                // Valuation Intelligence
                setupValuationIntelligence(data);

                // Value Assessment
                document.getElementById('detail-current-oas').textContent = `${get(['calculated_risk_metrics', 'option_adjusted_spread_bps'], data)} bps`;
                document.getElementById('detail-vs-peers').textContent = `${get(['relative_value', 'vs_peers_bps'], data)} bps`;
                document.getElementById('detail-vs-mmd').textContent = `${get(['relative_value', 'vs_mmd_bps'], data)} bps`;
                document.getElementById('detail-vs-ust').textContent = `${get(['relative_value', 'vs_ust_bps'], data)} bps`;
                
                // Liquidity Assessment
                document.getElementById('detail-liquidity-score').textContent = get(['liquidity', 'composite_score'], data);
                const isConcentrated = get(['ownership', 'is_concentrated_flag'], data);
                const isConcentratedEl = document.getElementById('detail-is-concentrated');
                isConcentratedEl.textContent = isConcentrated ? 'Yes' : 'No';
                isConcentratedEl.className = `font-semibold ${isConcentrated ? 'text-red-600' : 'text-green-600'}`;


                document.getElementById('detail-trade-1d').textContent = `${(get(['trade_history_summary', 't1d', 'total_par_volume'], data) / 1e6).toFixed(1)}M / ${get(['trade_history_summary', 't1d', 'unique_dealer_count'], data)}`;
                document.getElementById('detail-trade-5d').textContent = `${(get(['trade_history_summary', 't5d', 'total_par_volume'], data) / 1e6).toFixed(1)}M / ${get(['trade_history_summary', 't5d', 'unique_dealer_count'], data)}`;

                // Market Context
                const mc = data.market_context;
                if(mc) {
                    populateMarketRegime('detail-market-regime-container', 'Market Regime', mc.regime, mc.regime_drivers);
                }

                // Forecasts with Explainability
                const fv = data.forecasted_values;
                const fe = data.forecast_explainability;
                const ns = data.news_sentiment;
                
                createForecastLine('detail-credit-spread-1d', '1D Credit Spread (OAS)', get(['1-day', 'credit_spread_oas_bps'], fv), 'bps', get(['1-day.credit_spread_oas_bps', 'feature_attributions'], fe));
                createForecastLine('detail-credit-spread-5d', '5D Credit Spread (OAS)', get(['5-day', 'credit_spread_oas_bps'], fv), 'bps', get(['5-day.credit_spread_oas_bps', 'feature_attributions'], fe));
                createForecastLine('detail-credit-spread-20d', '20D Credit Spread (OAS)', get(['20-day', 'credit_spread_oas_bps'], fv), 'bps', get(['20-day.credit_spread_oas_bps', 'feature_attributions'], fe), 'value-assessment-panel');

                createForecastLine('detail-bid-ask-5d', '5D Bid/Ask Spread', get(['5-day', 'bid_ask_spread_pct'], fv), '%', get(['5-day.bid_ask_spread_pct', 'feature_attributions'], fe));
                
                const newsArticles = ns.top_articles.map(a => ({ feature: a.source, attribution: a.headline }));
                createForecastLine('detail-news-sentiment', 'News Sentiment', ns.score, '', newsArticles, null, 'right');
                createForecastLine('detail-neg-news-5d', '5D Neg. News Prob', get(['5-day', 'probability_negative_news_pct'], fv), '%', get(['5-day.probability_negative_news_pct', 'feature_attributions'], fe), null, 'right');
                createForecastLine('detail-downside-1d', '1D Downside Vol', get(['1-day', 'downside_price_volatility', 'value'], fv), '%', get(['1-day.downside_price_volatility.value', 'feature_attributions'], fe), null, 'right');
                createForecastLine('detail-downside-5d', '5D Downside Vol', get(['5-day', 'downside_price_volatility', 'value'], fv), '%', get(['1-day.downside_price_volatility.value', 'feature_attributions'], fe), null, 'right');
            }
            
            function setupValuationIntelligence(data) {
                const sliderContainer = document.getElementById('weight-sliders');
                const suggestedPriceInput = document.getElementById('suggested-price-input');
                const explanationEl = document.getElementById('suggested-price-explanation');
                const scenarioContainer = document.getElementById('scenario-buttons');
                const valuationActionContainer = document.getElementById('valuation-action-buttons');

                sliderContainer.innerHTML = ''; // Clear old sliders
                valuationActionContainer.innerHTML = ''; // Clear old buttons
                // Clear all but the first child (the label)
                while (scenarioContainer.children.length > 1) {
                    scenarioContainer.removeChild(scenarioContainer.lastChild);
                }


                const fv = data.forecasted_values;
                const crm = data.calculated_risk_metrics;
                const sd = data.security_details;
                const marketRegime = data.market_context?.regime;
                const negNewsProb = parseFloat(fv['1-day'].probability_negative_news_pct);

                const SCENARIO_WEIGHTS = {
                    'Base Case': { current: 40, d1: 30, d5: 20, d20: 10 },
                    'Defensive': { current: 80, d1: 10, d5: 5, d20: 5 },
                    'Aggressive Alpha': { current: 10, d1: 50, d5: 30, d20: 10 },
                    'Strategic Value': { current: 10, d1: 10, d5: 30, d20: 50 }
                };
                let activeScenario = 'Base Case';

                const oas = {
                    current: parseFloat(crm.option_adjusted_spread_bps),
                    d1: parseFloat(fv['1-day'].credit_spread_oas_bps),
                    d5: parseFloat(fv['5-day'].credit_spread_oas_bps),
                    d20: parseFloat(fv['20-day'].credit_spread_oas_bps),
                };

                const weights = { current: 50, d1: 25, d5: 15, d20: 10 }; 
                const sliderElements = {};
                
                const horizons = [
                    { key: 'current', label: 'Current OAS' },
                    { key: 'd1', label: '1-Day Forecast' },
                    { key: 'd5', label: '5-Day Forecast' },
                    { key: 'd20', label: '20-Day Forecast' },
                ];

                horizons.forEach(h => {
                    const sliderWrapper = document.createElement('div');
                    sliderWrapper.className = 'flex items-center space-x-2';
                    sliderWrapper.innerHTML = `
                        <label for="${h.key}-weight" class="text-xs w-28">${h.label}:</label>
                        <input type="range" id="${h.key}-weight" min="0" max="100" value="${weights[h.key]}" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        <span id="${h.key}-value" class="text-xs w-8 text-right font-mono">${weights[h.key]}%</span>
                    `;
                    sliderContainer.appendChild(sliderWrapper);

                    const input = sliderWrapper.querySelector('input');
                    const valueSpan = sliderWrapper.querySelector(`#${h.key}-value`);
                    sliderElements[h.key] = { input, valueSpan };

                    input.addEventListener('input', (e) => {
                        weights[h.key] = parseInt(e.target.value, 10);
                        valueSpan.textContent = `${weights[h.key]}%`;
                        // When user manually slides, deactivate scenario buttons
                        activeScenario = null; 
                        updateScenarioButtons();
                        updateSuggestedPrice();
                    });
                });
                
                const bwd = data.bid_wanted_details;
                let bidBtn, offerBtn;

                function updateButtonText() {
                    if (bwd) {
                        const formattedSize = bwd.size >= 1000000 ? `${bwd.size / 1000000}mm` : `${bwd.size / 1000}k`;
                        const currentPrice = suggestedPriceInput.value;
                        if (bidBtn) {
                            bidBtn.textContent = `Bid ${formattedSize} @ ${currentPrice}`;
                        }
                        if (offerBtn) {
                            const offerPrice = (parseFloat(currentPrice) * 1.0025).toFixed(3);
                            offerBtn.textContent = `Offer ${formattedSize} @ ${offerPrice}`;
                        }
                    }
                }

                if (bwd) {
                    const formattedSize = bwd.size >= 1000000 ? `${bwd.size/1000000}mm` : `${bwd.size/1000}k`;
                    const primaryBtnClass = 'bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded text-sm transition-all duration-200';
                    const secondaryBtnClass = 'bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold py-1.5 px-3 rounded text-sm transition-all duration-200';

                    bidBtn = document.createElement('button');
                    bidBtn.className = bwd.side === 'BWIC' ? primaryBtnClass : secondaryBtnClass;
                    bidBtn.addEventListener('click', () => handleAction('bid', formattedSize, suggestedPriceInput.value));

                    offerBtn = document.createElement('button');
                    offerBtn.className = bwd.side === 'OWIC' ? primaryBtnClass : secondaryBtnClass;
                    offerBtn.addEventListener('click', () => {
                         const offerPrice = (parseFloat(suggestedPriceInput.value) * 1.0025).toFixed(3);
                         handleAction('offer', formattedSize, offerPrice);
                    });
                    
                    valuationActionContainer.appendChild(bidBtn);
                    valuationActionContainer.appendChild(offerBtn);
                }

                suggestedPriceInput.addEventListener('input', () => {
                    activeScenario = null;
                    updateScenarioButtons();
                    updateButtonText();
                });
                
                function applyScenario(scenarioName) {
                    activeScenario = scenarioName;
                    const scenarioWeights = SCENARIO_WEIGHTS[scenarioName];
                    
                    for(const key in scenarioWeights) {
                        weights[key] = scenarioWeights[key];
                        sliderElements[key].input.value = weights[key];
                        sliderElements[key].valueSpan.textContent = `${weights[key]}%`;
                    }
                    updateScenarioButtons();
                    updateSuggestedPrice();
                }

                function updateScenarioButtons() {
                     scenarioContainer.querySelectorAll('button').forEach(btn => {
                        if (btn.textContent === activeScenario) {
                            btn.className = 'text-xs bg-blue-600 text-white font-semibold py-1 px-2 rounded';
                        } else {
                            btn.className = 'text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold py-1 px-2 rounded';
                        }
                    });
                }
                
                Object.keys(SCENARIO_WEIGHTS).forEach(name => {
                    const btn = document.createElement('button');
                    btn.textContent = name;
                    scenarioContainer.appendChild(btn);
                    btn.addEventListener('click', () => applyScenario(name));
                });


                function updateSuggestedPrice() {
                    let totalWeight = 0;
                    let weightedOASSum = 0;

                    for (const key in weights) {
                        totalWeight += weights[key];
                        weightedOASSum += oas[key] * weights[key];
                    }

                    if (totalWeight === 0) {
                        suggestedPriceInput.value = '-';
                        explanationEl.textContent = 'Adjust weights to see a suggestion.';
                        return;
                    }
                    
                    const oas_agg = weightedOASSum / totalWeight;
                    const oas_change_bps = oas_agg - oas.current;
                    const p0 = parseFloat(sd.price);
                    const mod_dur = parseFloat(crm.modified_duration);
                    const price_change = -mod_dur * (oas_change_bps / 100) * (p0 / 100);
                    const p_sugg = p0 + price_change;
                    
                    suggestedPriceInput.value = p_sugg.toFixed(3);
                    
                    let explanation = activeScenario ? `[${activeScenario}] ` : '[Custom] ';
                    explanation += `Based on an aggregated OAS of <b>${oas_agg.toFixed(2)}bps</b>`;
                    if (Math.abs(oas_change_bps) > 0.1) {
                        const direction = oas_change_bps < 0 ? 'tightening' : 'widening';
                        explanation += `, implying a spread ${direction} of <b>${Math.abs(oas_change_bps).toFixed(2)}bps</b>.`;
                    } else {
                        explanation += `, effectively neutral to current spread.`;
                    }
                    explanationEl.innerHTML = explanation;
                    updateButtonText();
                }
                
                const riskOffRegimes = ['Bear_Flattener', 'Bear_Steepener', 'Recession_Easing', 'Idiosyncratic_Distress'];

                // Determine initial scenario
                if (negNewsProb > 15 || riskOffRegimes.includes(marketRegime)) {
                    applyScenario('Defensive');
                } else {
                    applyScenario('Base Case');
                }
            }

            function createForecastLine(elementId, label, value, unit, attributions, parentDivId, tooltipAlign) {
                let container = document.getElementById(elementId);
                // If the element doesn't exist, create it and append it to a parent
                if (!container && parentDivId) {
                    const parent = document.querySelector(`#${parentDivId}`);
                    if (parent) {
                        container = document.createElement('div');
                        container.id = elementId;
                        container.className = 'explain-container relative text-xs';
                        parent.appendChild(container);
                    }
                }
                if (!container) return; // Exit if container still not found

                let infoIcon = '';
                if (attributions && attributions.length > 0) {
                    const tooltipText = attributions.map(a => `<div>${a.feature}: <span class='font-mono'>${a.attribution}</span></div>`).join('');
                    const alignClass = tooltipAlign === 'right' ? 'tooltip-right' : '';
                    infoIcon = `
                        <span class="has-tooltip relative ml-2 text-slate-500 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <div class="explain-tooltip font-sans ${alignClass}">${tooltipText}</div>
                        </span>`;
                }

                container.innerHTML = `
                    <div class="flex justify-between">
                        <span>${label}:</span>
                        <div>
                            <span class="font-semibold font-mono">${value} ${unit}</span>
                            ${infoIcon}
                        </div>
                    </div>`;
            }

            function populateMarketRegime(elementId, label, value, drivers) {
                 const container = document.getElementById(elementId);
                 if (!container) return;

                let infoIcon = '';
                if (drivers && drivers.length > 0) {
                    const tooltipText = drivers.map(d => `<div>${d.feature}: <span class='font-mono'>${d.attribution}</span></div>`).join('');
                    infoIcon = `
                        <span class="has-tooltip relative ml-1 text-slate-500 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <div class="explain-tooltip tooltip-right font-sans">${tooltipText}</div>
                        </span>`;
                }
                
                const formattedValue = value.replace(/_/g, ' ');

                container.innerHTML = `
                    <div class="text-xs text-slate-400">${label}</div>
                    <div class="text-base font-semibold text-slate-200 flex items-center justify-end">
                        <span>${formattedValue}</span>
                        ${infoIcon}
                    </div>
                `;
            }

            function isHighConviction(row) {
                return Number(row.forecasted_oas_change_1d_bps) < -5 &&
                       row.liquidity.is_illiquid_flag === false &&
                       Number(row.forecasted_values['1-day'].probability_negative_news_pct) < 5;
            }

            function checkForOpportunities(data) {
                data.forEach(row => {
                    if (isHighConviction(row)) {
                        createAlert(row);
                    }
                });
            }

            function createAlert(row) {
                const alertContainer = document.getElementById('alert-container');
                const alertId = `alert-${row.cusip}`;

                // Avoid duplicate alerts
                if (document.getElementById(alertId)) return;

                const drivers = row.forecast_explainability?.forecasted_oas_change_1d_bps?.feature_attributions
                    ?.filter(a => a.attribution < 0) // Show positive drivers (negative attribution means tightening)
                    .slice(0, 3)
                    .map(d => `<li class="text-xs">${d.feature}: <span class="font-semibold font-mono">${d.attribution}</span></li>`)
                    .join('') || '<li>No drivers available</li>';

                const alertEl = document.createElement('div');
                alertEl.id = alertId;
                alertEl.className = 'bg-slate-800 border border-slate-700 rounded-md shadow-lg p-3 animate-fade-in-right';
                alertEl.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <div class="ml-3 w-0 flex-1">
                            <p class="text-sm font-medium text-slate-100">
                                High-Conviction Opportunity
                            </p>
                            <p class="mt-1 text-sm text-slate-300">
                                <span class="font-bold font-mono">${row.cusip}</span> - ${row.security_details.issuer_name}
                            </p>
                             <p class="mt-1 text-sm text-green-400">
                                Forecasted Tightening: <span class="font-bold font-mono">${row.forecasted_oas_change_1d_bps} bps</span>
                            </p>
                            <p class="mt-2 text-xs text-slate-400">Positive Drivers:</p>
                            <ul class="list-disc list-inside ml-2">${drivers}</ul>
                            <div class="mt-3 flex space-x-3">
                                <button class="view-details-btn bg-blue-600 text-white px-2 py-1 text-xs rounded hover:bg-blue-700">View Details</button>
                                <button class="dismiss-btn text-slate-400 hover:text-slate-200 text-xs">Dismiss</button>
                            </div>
                        </div>
                         <div class="ml-4 flex-shrink-0 flex">
                            <button class="close-btn inline-flex text-gray-500 rounded-md hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-indigo-500">
                                <span class="sr-only">Close</span>
                                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                `;

                const close = () => {
                    alertEl.classList.add('animate-fade-out-right');
                    setTimeout(() => alertEl.remove(), 300);
                };

                alertEl.querySelector('.close-btn').addEventListener('click', close);
                alertEl.querySelector('.dismiss-btn').addEventListener('click', close);
                alertEl.querySelector('.view-details-btn').addEventListener('click', () => {
                    onRowClicked({ data: row });
                    close();
                });

                alertContainer.appendChild(alertEl);
            }

        });
    </script>

</body>
</html> 