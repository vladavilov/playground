# Security Info Service

## 1. Overview and Purpose

The Security Info Service is responsible for retrieving and serving static reference data about fixed-income instruments from the Caesar Oracle Database.

- Retrieve historical reference data.
- Store records in a local PostgreSQL database and export to CSV format.
- Provide daily incremental updates for newly added or modified data.
- Serve on-demand SecurityMaster data through a RESTful API by CUSIP.
- Support Treasury ticks and benchmark yield curves for enhanced analytics.

---

## 2. Architecture and Tech Stack

### Key Technologies

- **Oracle Database (Caesar)**: Source system for instrument reference data.
- **PostgreSQL**: Relational database for storing SecurityMaster and CallSchedule records.
- **Python 3**: Core language for service logic, ETL, and API development.
- **FastAPI**: Lightweight, modern web framework for building APIs, with built-in OpenAPI docs.
- **SQLAlchemy**: ORM layer for PostgreSQL database interaction.
- **oracledb**: Python library for Oracle DB connectivity.

---

## 3. Data Model and Schema

### 3.1 SecurityMaster Table

Main source of truth is the table `common_summary` where `instr_id_type = 'C'`

| Column Name        | Data Type | Description | Source | CSV Export |
|--------------------|-----------|-----------------------------------------------------------------------------|--------|------------|
| cusip              | TEXT (PK) | Unique identifier for the security | instr_id | YES |
| instrument_type    | TEXT      | Classification: 'MUNI', 'TFI_CORPORATE', 'TFI_TREASURY', 'TFI_AGENCY' | TBD | YES |
| issuer_name        | TEXT      | Name of the issuing entity | q_isr_name | YES |
| coupon_rate        | REAL      | Annual coupon rate | qs_coupon_rate | YES |
| maturity_date      | DATE      | Date the instrument matures | qs_matur_date | YES |
| payment_frequency  | INTEGER   | Number of coupon payments per year | JOIN interest_pay_freq_types | YES |
| face_value         | REAL      | Face/par value of the instrument | TBD | YES |
| sector             | TEXT      | For MUNI: 'GENERAL_OBLIGATION', 'REVENUE_TRANSPORTATION', etc. | pt_purpose_subclass_desc | YES |
| rating             | TEXT      | Credit rating (e.g., Moodyâ€™s, S&P) | TBD | YES |
| state              | TEXT      | U.S. state of issuance (only for MUNI) | qs_isr_state_code | YES |
| tax_status         | TEXT      | Tax treatment: 'TAX_EXEMPT_FEDERAL', 'TAXABLE', 'AMT', etc. | TBD | YES |
| de_minimis_issue         | BOOLEAN      | Indicates if the bond is subject to the de minims tax rule | TBD | YES |
| bank_qualified     | BOOL      | "Bank qualified" under the Tax Equity and Fiscal Responsibility Act of 1982 | ta_bank_qualif_stat = 'Y' | YES |
| debt_service_coverage_ratio    | REAL| Issuer's DSCR | TBD | YES |
| is_dsr_covenant_breached       | BOOL| The issuer has breached a Debt Service Coverage ratio covenant | TBD | YES |
| load_date          | DATE      | Date when the record was loaded into the local DB | Derived | NO |

```sql
-- payment_frequency
SELECT
  ipft.freq_per_year as payment_frequency
FROM
  common_summary
LEFT JOIN interest_pay_freq_types AS ipft
  ON ipft.int_freq_code = common_summary.in_int_pay_freq_std_period

```

### 3.2 CallSchedule Table

| Column Name             | Data Type           | Description | Source    | CSV Export |
|-------------------------|---------------------|-------------------------------------------------------------|-----------|------------|
| id                      | PK, AUTOINCREMENT | Primary key | DB  | No |
| security_master_cusip   | TEXT              | FK SecurityMaster.cusip | TBD | Yes |
| call_date               | DATE              | Date the call option can be exercised | TBD | Yes |
| call_price              | REAL              | Call price | TBD | Yes |
| call_type               | TEXT              | 'AMERICAN', 'EUROPEAN', 'BERMUDAN', or 'NO_CALL' | TBD | Yes |
| load_date               | DATE              | Load date, Autogenerated | DB | No |

### 3.3 TreasuryTick Table

| Column Name     | Data Type | Description                              | Source | CSV Export |
|-----------------|-----------|------------------------------------------|--------|------------|
| id              | PK, AUTOINCREMENT | Unique identifier             | DB     | No         |
| security_type   | TEXT      | E.g., 'UST' (U.S. Treasury)              | TBD    | Yes        |
| cusip           | TEXT      | Security identifier (if applicable)      | TBD    | Yes        |
| quote_time      | TIMESTAMP | Time of the quote                        | TBD    | Yes        |
| price           | REAL      | Last traded price                        | TBD    | Yes        |
| yield           | REAL      | Yield associated with the quote          | TBD    | Yes        |
| load_date       | DATE      | Load date into system                    | DB     | No         |

### 3.4 BenchmarkCurvePoint Table

| Column Name     | Data Type | Description                                        | Source | CSV Export |
|-----------------|-----------|----------------------------------------------------|--------|------------|
| id              | PK, AUTOINCREMENT | Unique identifier                     | DB     | No         |
| curve_date      | DATE      | The date the curve was recorded                  | TBD    | Yes        |
| tenor           | TEXT      | E.g., '1Y', '2Y', '5Y', '10Y', '30Y'              | TBD    | Yes        |
| yield           | REAL      | Yield at that tenor                              | TBD    | Yes        |
| curve_type      | TEXT      | E.g., 'UST', 'SOFR', etc.                        | TBD    | Yes        |
| load_date       | DATE      | Load date into system                            | DB     | No         |

---

## 4. API Endpoints

### 4.1 `/historical`

**Purpose**: Retrieve and load all historical SecurityMaster and CallSchedule data from `start_date` to `end_date`.

- Inserts full data into PostgreSQL database if `reportOnly=false`.
- Writes export to CSV.

**Example**:
```http
Request:
POST /historical?reportOnly=true&start_date=2018-01-01&end_date=2025-01-01
Response:
data.csv
```

### 4.2 `/update`

**Purpose**: Perform an incremental update for the specified `input_date`.

- Adds new records or updates changed records for a given date.
- Provides report if `proivdeReport=true`.

**Example**:
```http
Request:
POST /update?proivdeReport=true
Content-Type: application/json

{
  "input_date": "2023-01-05"
}

Response:
data.csv
```

### 4.3 `/actual`

**Purpose**: Retrieve current SecurityMaster and CallSchedule data for a given CUSIP, including latest Treasury tick (if available) and current benchmark yield curve.

- Always includes:
  - Matching SecurityMaster record
  - Associated CallSchedule records
  - Latest Treasury tick for the CUSIP (returns `null` if not available)
  - Latest benchmark yield curve

**Example**:
```http
GET /actual?cusip=9128285Q9
```

**Response**:
```json
{
  "cusip": "9128285Q9",
  "instrument_type": "TFI_TREASURY",
  "issuer_name": "US Treasury",
  "coupon_rate": 3.25,
  "maturity_date": "2032-11-15",
  "call_schedule": [],
  "latest_tick": {
    "quote_time": "2025-06-25T15:30:00Z",
    "price": 99.875,
    "yield": 3.28
  },
  "benchmark_curve": [
    { "tenor": "1Y", "yield": 3.12 },
    { "tenor": "2Y", "yield": 3.20 },
    { "tenor": "5Y", "yield": 3.35 },
    { "tenor": "10Y", "yield": 3.45 },
    { "tenor": "30Y", "yield": 3.60 }
  ]
}
```

If tick data is not available:
```json
"latest_tick": null
```

---

## 5. Audit tables

As soon as any row of data is inserted, changed or deleted, a new state is saved to `table_name_audit` containing the same columns as `table_name`, plus `update_datetime`.

---

## 6. Setup & Environment Guide

### Prerequisites

- **Python 3.14+**
- **PostgreSQL 17+** installed and running.
- **Access to Caesar Oracle DB**
- Install Python dependencies:

```bash
pip install oracledb fastapi uvicorn sqlalchemy psycopg2-binary
```

### Configuration

Create a `config.ini` file with:

```ini
[ORACLE]
username=your_oracle_username
password=your_oracle_password
dsn=your_oracle_dsn

[POSTGRES]
host=localhost
port=5432
user=postgres
password=your_pg_password
database=security_info
```
