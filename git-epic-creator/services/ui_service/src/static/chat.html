<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900 h-screen w-screen">
  <div class="flex flex-col h-screen w-screen">
    <!-- Header: project title + status badge -->
    <header class="flex items-center justify-between px-4 py-3 border-b bg-white">
      <div class="flex items-center gap-2">
        <a href="/" class="text-sky-600 underline">← Back</a>
        <h1 id="chatProjectTitle" class="text-lg font-semibold">Project</h1>
        <span id="chatProjectStatus"></span>
      </div>
      <div class="text-xs text-slate-500">Live agent updates</div>
    </header>

    <!-- Content area: markdown output + agent events -->
    <main class="flex-1 grid grid-rows-[1fr_auto]">
      <section class="overflow-y-auto p-4" id="chatOutput">
        <!-- Chat/LLM markdown-rendered messages go here -->
      </section>

      <!-- Bottom input row -->
      <footer class="border-t bg-white p-3">
        <form id="chatForm" class="flex items-end gap-2">
          <textarea id="chatInput" class="flex-1 border rounded px-3 py-2 min-h-[44px]" rows="2" placeholder="Ask about requirements or propose changes..."></textarea>
          <button id="chatSend" class="px-4 py-2 bg-indigo-600 text-white rounded">Send</button>
        </form>
        <div id="chatHint" class="text-xs text-slate-500 mt-1">Shift+Enter for newline, Enter to send.</div>
      </footer>
    </main>
  </div>

  <script type="module">
    'use strict';
    // Simple markdown renderer: supports headings, bold, italics, code fences, lists, links
    function renderMarkdown(md) {
      let html = (md || '').replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]));
      html = html
        .replace(/^###\s+(.*)$/gm, '<h3 class="text-base font-semibold mt-3">$1</h3>')
        .replace(/^##\s+(.*)$/gm, '<h2 class="text-lg font-semibold mt-4">$1</h2>')
        .replace(/^#\s+(.*)$/gm, '<h1 class="text-xl font-bold mt-5">$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1<\/strong>')
        .replace(/\*(.*?)\*/g, '<em>$1<\/em>')
        .replace(/`([^`]+)`/g, '<code class="bg-slate-100 px-1 rounded">$1<\/code>')
        .replace(/```([\s\S]*?)```/g, '<pre class="bg-slate-900 text-slate-100 p-3 rounded overflow-auto"><code>$1<\/code><\/pre>')
        .replace(/^\s*[-*]\s+(.*)$/gm, '<li class="list-disc ml-6">$1<\/li>')
        .replace(/\[(.+?)\]\((https?:[^\s]+)\)/g, '<a href="$2" target="_blank" class="text-sky-600 underline">$1<\/a>');
      // Wrap orphan list items
      html = html.replace(/(<li[\s\S]*?<\/li>)/g, '<ul>$1<\/ul>');
      return html;
    }

    function getStatusBadge(status) {
      const s = (status || '').toLowerCase();
      const base = 'inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ';
      let cls = 'bg-slate-100 text-slate-700';
      if (s === 'processing') cls = 'bg-blue-100 text-blue-700';
      else if (s === 'active') cls = 'bg-emerald-100 text-emerald-700';
      else if (s === 'rag_processing') cls = 'bg-teal-100 text-teal-700';
      else if (s === 'rag_ready') cls = 'bg-green-100 text-green-700';
      else if (s.includes('failed') || s === 'rag_failed') cls = 'bg-rose-100 text-rose-700';
      const span = document.createElement('span');
      span.className = base + cls;
      span.textContent = s || 'unknown';
      return span;
    }

    const chatOutput = document.getElementById('chatOutput');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const projectTitleEl = document.getElementById('chatProjectTitle');
    const projectStatusEl = document.getElementById('chatProjectStatus');

    const state = { config: null, token: null, projectId: null, project: null };

    function scrollToBottom() { chatOutput.scrollTop = chatOutput.scrollHeight; }

    function appendUserMessage(text) {
      const wrap = document.createElement('div');
      wrap.className = 'mb-3';
      wrap.innerHTML = `<div class="text-xs text-slate-500 mb-1">You</div><div class="bg-white border rounded p-3">${renderMarkdown(text)}</div>`;
      chatOutput.appendChild(wrap); scrollToBottom();
    }

    function appendModelMessage(md, meta) {
      const wrap = document.createElement('div');
      wrap.className = 'mb-3';
      const header = meta ? `<div class="text-xs text-slate-500 mb-1">${meta}</div>` : '';
      wrap.innerHTML = `${header}<div class="bg-slate-50 border rounded p-3">${renderMarkdown(md)}</div>`;
      chatOutput.appendChild(wrap); scrollToBottom();
    }

    async function loadConfig() {
      const r = await fetch('/config'); state.config = await r.json();
    }

    async function fetchDevToken() {
      try { const t = await fetch('/dev-token', { method: 'POST' }).then(r=>r.json()); state.token = t.access_token || null; } catch {}
    }

    async function loadProject() {
      const id = location.hash ? location.hash.substring(1) : '';
      state.projectId = id;
      if (!id) return;
      const base = state.config.projectManagementApiBase.replace(/\/$/, '');
      const res = await fetch(`${base}/projects/${id}`, { headers: state.token ? { 'Authorization': `Bearer ${state.token}` } : {} });
      if (!res.ok) return;
      state.project = await res.json();
      projectTitleEl.textContent = state.project.name || '(untitled)';
      projectStatusEl.innerHTML = ''; projectStatusEl.appendChild(getStatusBadge(state.project.status));
    }

    function setupInputBehavior() {
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); chatForm.requestSubmit(); }
      });
      chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (!text) return;
        appendUserMessage(text);
        chatInput.value = '';
        // Send to backend mock chat endpoint
        try {
          const res = await fetch('/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ project_id: state.projectId, prompt: text })
          });
          if (res.ok) {
            const data = await res.json();
            appendModelMessage(data.content || '');
          } else {
            appendModelMessage('Error: failed to get response', 'System');
          }
        } catch (err) {
          appendModelMessage('Network error while sending message', 'System');
        }
      });
    }

    function subscribeSSE() {
      const es = new EventSource('/events');
      es.addEventListener('project_progress', (evt) => {
        try {
          const msg = JSON.parse(evt.data);
          if (!state.projectId || String(state.projectId) !== String(msg.project_id)) return;
          projectStatusEl.innerHTML = ''; projectStatusEl.appendChild(getStatusBadge(msg.status));
          // Optional: show agentic step updates if provided
          if (msg.step || msg.score != null) {
            const meta = `Step: ${msg.step ?? '-'}  Score: ${msg.score ?? '-'}`;
            appendModelMessage(`Workflow update — ${meta}`, 'Agent');
          }
        } catch {}
      });
    }

    (async function init(){
      await loadConfig();
      await fetchDevToken();
      await loadProject();
      setupInputBehavior();
      subscribeSSE();
    })().catch(console.error);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="max-w-3xl mx-auto p-6">
    <a href="/" class="text-sky-600 underline">← Back</a>
    <h1 class="text-2xl font-semibold mt-4">Requirements Chat</h1>
    <p class="text-sm text-slate-600">Coming soon: Agentic workflow to populate GitLab issues.</p>
    <div class="mt-6 bg-white border rounded p-4">
      <label class="block text-sm text-slate-600">Project ID</label>
      <input id="projectId" class="w-full border rounded px-3 py-2" placeholder="UUID" />
      <div class="mt-4 flex gap-2">
        <input id="message" class="flex-1 border rounded px-3 py-2" placeholder="Type a message..." />
        <button class="px-4 py-2 bg-indigo-600 text-white rounded" onclick="send()">Send</button>
      </div>
    </div>
  </main>
  <script>
    function send(){ alert('This is a placeholder for the agentic chat flow.'); }
  </script>
</body>
</html>


