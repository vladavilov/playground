# GitLab CI/CD Pipeline for Agentic AI - Git Epic Creator
# Deploys to Azure AKS using Bicep infrastructure and Kustomize

variables:
  # Azure Configuration
  AZURE_SUBSCRIPTION_ID: $AZURE_SUBSCRIPTION_ID
  AZURE_TENANT_ID: $AZURE_TENANT_ID
  AZURE_REGION: eastus2
  
  # Environment Configuration
  PROJECT_NAME: agentic-ai
  
  # Docker Configuration (uses corporate registry)
  # Set CONTAINER_REGISTRY_LOGIN_SERVER, CONTAINER_REGISTRY_USER, CONTAINER_REGISTRY_PASSWORD in CI/CD variables
  DOCKER_IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_DRIVER: overlay2

stages:
  - validate
  - build
  - test
  - infrastructure
  - deploy
  - verify

# =============================================================================
# TEMPLATES
# =============================================================================

.azure_cli_setup: &azure_cli_setup
  before_script:
    - curl -sL https://aka.ms/InstallAzureCLIDeb | bash
    - az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
    - az account set --subscription $AZURE_SUBSCRIPTION_ID

.docker_build_template: &docker_build
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - echo "Logging into corporate container registry..."
    - echo "$CONTAINER_REGISTRY_PASSWORD" | docker login -u "$CONTAINER_REGISTRY_USER" --password-stdin "$CONTAINER_REGISTRY_LOGIN_SERVER"
  script:
    - echo "Building $SERVICE_NAME..."
    - cd services
    - |
      # Normalize image name: underscores to dashes
      IMAGE_NAME=$(echo "$SERVICE_NAME" | tr '_' '-')
      if [ -f "./$SERVICE_NAME/Dockerfile" ]; then
        docker build -f ./$SERVICE_NAME/Dockerfile -t $CONTAINER_REGISTRY_LOGIN_SERVER/$IMAGE_NAME:$DOCKER_IMAGE_TAG -t $CONTAINER_REGISTRY_LOGIN_SERVER/$IMAGE_NAME:latest .
        docker push $CONTAINER_REGISTRY_LOGIN_SERVER/$IMAGE_NAME:$DOCKER_IMAGE_TAG
        docker push $CONTAINER_REGISTRY_LOGIN_SERVER/$IMAGE_NAME:latest
      else
        echo "Dockerfile not found for $SERVICE_NAME"
        exit 1
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

.test_service_template: &test_service
  stage: test
  image: python:3.13-slim
  before_script:
    - cd services/$SERVICE_NAME
    - pip install -e .[dev] || pip install -e .
    - pip install -e ../shared || true
  script:
    - python -m pytest tests/ -v --tb=short || echo "No tests found"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# VALIDATE STAGE
# =============================================================================

validate:bicep:
  stage: validate
  image: mcr.microsoft.com/azure-cli:latest
  <<: *azure_cli_setup
  script:
    - cd infra
    - az bicep build --file main.bicep
    - echo "Bicep validation successful"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

validate:kustomize:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
    - curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
    - mv kustomize /usr/local/bin/
  script:
    - cd k8s/overlays/dev
    - kustomize build . > /dev/null
    - echo "Kustomize validation successful"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# BUILD STAGE - All Services
# =============================================================================

build:db-init-service:
  <<: *docker_build
  variables:
    SERVICE_NAME: db_init_service

build:project-management-service:
  <<: *docker_build
  variables:
    SERVICE_NAME: project_management_service

## neo4j_maintanance_service removed (replaced by neo4j_repository_service)

build:neo4j-ingestion-service:
  <<: *docker_build
  variables:
    SERVICE_NAME: neo4j_ingestion_service

build:neo4j-retrieval-service:
  <<: *docker_build
  variables:
    SERVICE_NAME: neo4j_retrieval_service

build:ui-service:
  <<: *docker_build
  variables:
    SERVICE_NAME: ui_service

build:document-processing-service:
  <<: *docker_build
  variables:
    SERVICE_NAME: document_processing_service

build:ai-requirements-service:
  <<: *docker_build
  variables:
    SERVICE_NAME: ai_requirements_service

build:ai-tasks-service:
  <<: *docker_build
  variables:
    SERVICE_NAME: ai_tasks_service

build:gitlab-client-service:
  <<: *docker_build
  variables:
    SERVICE_NAME: gitlab_client_service

build:mock-auth-service:
  <<: *docker_build
  variables:
    SERVICE_NAME: mock_auth_service

build:neo4j-baked:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - echo "Logging into corporate container registry..."
    - echo "$CONTAINER_REGISTRY_PASSWORD" | docker login -u "$CONTAINER_REGISTRY_USER" --password-stdin "$CONTAINER_REGISTRY_LOGIN_SERVER"
  script:
    - cd services
    - docker build -f ./neo4j_baked/Dockerfile -t $CONTAINER_REGISTRY_LOGIN_SERVER/neo4j-baked:$DOCKER_IMAGE_TAG -t $CONTAINER_REGISTRY_LOGIN_SERVER/neo4j-baked:latest .
    - docker push $CONTAINER_REGISTRY_LOGIN_SERVER/neo4j-baked:$DOCKER_IMAGE_TAG
    - docker push $CONTAINER_REGISTRY_LOGIN_SERVER/neo4j-baked:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# =============================================================================
# TEST STAGE
# =============================================================================

test:shared:
  <<: *test_service
  variables:
    SERVICE_NAME: shared

test:project-management-service:
  <<: *test_service
  variables:
    SERVICE_NAME: project_management_service

test:document-processing-service:
  <<: *test_service
  variables:
    SERVICE_NAME: document_processing_service

## neo4j_maintanance_service removed (replaced by neo4j_repository_service)

test:ai-tasks-service:
  <<: *test_service
  variables:
    SERVICE_NAME: ai_tasks_service

test:gitlab-client-service:
  <<: *test_service
  variables:
    SERVICE_NAME: gitlab_client_service

# =============================================================================
# INFRASTRUCTURE STAGE
# =============================================================================

infrastructure:deploy:
  stage: infrastructure
  image: mcr.microsoft.com/azure-cli:latest
  <<: *azure_cli_setup
  script:
    - cd infra
    - DEPLOYMENT_PRINCIPAL_ID=$(az ad signed-in-user show --query "id" -o tsv || az ad sp show --id $AZURE_CLIENT_ID --query "id" -o tsv)
    - |
      az deployment sub create \
        --name "agentic-ai-${ENVIRONMENT}-$(date +%Y%m%d-%H%M)" \
        --location $AZURE_REGION \
        --template-file main.bicep \
        --parameters environment=$ENVIRONMENT \
        --parameters aadClientId=$AAD_CLIENT_ID \
        --parameters tenantId=$AZURE_TENANT_ID \
        --parameters adminGroupObjectId=$ADMIN_GROUP_OBJECT_ID \
        --parameters deploymentPrincipalId=$DEPLOYMENT_PRINCIPAL_ID \
        --parameters containerRegistryLoginServer=$CONTAINER_REGISTRY_LOGIN_SERVER \
        --parameters sessionSecretKey=$SESSION_SECRET_KEY \
        --parameters localJwtSecret=$LOCAL_JWT_SECRET \
        --parameters neo4jPassword=$NEO4J_PASSWORD \
        --parameters postgresPassword=$POSTGRES_PASSWORD \
        --parameters gitlabOAuthClientSecret=$GITLAB_OAUTH_CLIENT_SECRET
    - echo "Infrastructure deployment completed"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  environment:
    name: $ENVIRONMENT
    action: prepare

# =============================================================================
# DEPLOY STAGE
# =============================================================================

deploy:application:
  stage: deploy
  image: mcr.microsoft.com/azure-cli:latest
  <<: *azure_cli_setup
  script:
    - |
      # Install kubectl and kustomize
      az aks install-cli
      curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
      mv kustomize /usr/local/bin/
      
      # Get deployment outputs
      RESOURCE_GROUP="agentic-ai-${ENVIRONMENT}-rg"
      AKS_CLUSTER=$(az deployment sub show --name "agentic-ai-${ENVIRONMENT}" --query "properties.outputs.aksClusterName.value" -o tsv)
      WORKLOAD_IDENTITY_CLIENT_ID=$(az deployment sub show --name "agentic-ai-${ENVIRONMENT}" --query "properties.outputs.workloadIdentityClientId.value" -o tsv)
      APP_CONFIG_ENDPOINT=$(az deployment sub show --name "agentic-ai-${ENVIRONMENT}" --query "properties.outputs.appConfigEndpoint.value" -o tsv)
      REDIS_HOST=$(az deployment sub show --name "agentic-ai-${ENVIRONMENT}" --query "properties.outputs.redisHostName.value" -o tsv)
      OAI_ENDPOINT=$(az deployment sub show --name "agentic-ai-${ENVIRONMENT}" --query "properties.outputs.openAiEndpoint.value" -o tsv)
      STORAGE_BLOB_ENDPOINT=$(az deployment sub show --name "agentic-ai-${ENVIRONMENT}" --query "properties.outputs.storageEndpoints.value.blob" -o tsv)
      KEY_VAULT_NAME=$(az deployment sub show --name "agentic-ai-${ENVIRONMENT}" --query "properties.outputs.keyVaultName.value" -o tsv)
      APP_CONFIG_NAME="agentic-ai-${ENVIRONMENT}-appconfig"
      
      # Use corporate registry from CI/CD variables
      REGISTRY=${CONTAINER_REGISTRY_LOGIN_SERVER}
      
      # Get AKS credentials
      az aks get-credentials --resource-group $RESOURCE_GROUP --name $AKS_CLUSTER --overwrite-existing
      
      # Create namespace if not exists
      kubectl create namespace agentic-ai --dry-run=client -o yaml | kubectl apply -f -
      
      # Create image pull secret for corporate registry
      kubectl create secret docker-registry regcred \
        --docker-server=$CONTAINER_REGISTRY_LOGIN_SERVER \
        --docker-username=$CONTAINER_REGISTRY_USER \
        --docker-password=$CONTAINER_REGISTRY_PASSWORD \
        -n agentic-ai --dry-run=client -o yaml | kubectl apply -f -
      
      # Install NGINX Ingress Controller if not exists
      helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx || true
      helm repo update
      helm upgrade --install nginx-ingress ingress-nginx/ingress-nginx \
        --namespace ingress-nginx --create-namespace \
        --set controller.service.type=LoadBalancer \
        --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-internal"="true" || true
      
      # Update Kustomization with actual values
      cd k8s/overlays/${ENVIRONMENT}
      
      # Set images with kustomize using corporate registry
      # Note: neo4j-maintanance-service keeps original misspelling to match directory name
      kustomize edit set image \
        db-init-service=${REGISTRY}/db-init-service:${DOCKER_IMAGE_TAG} \
        project-management-service=${REGISTRY}/project-management-service:${DOCKER_IMAGE_TAG} \
        neo4j-maintanance-service=${REGISTRY}/neo4j-maintanance-service:${DOCKER_IMAGE_TAG} \
        neo4j-ingestion-service=${REGISTRY}/neo4j-ingestion-service:${DOCKER_IMAGE_TAG} \
        neo4j-retrieval-service=${REGISTRY}/neo4j-retrieval-service:${DOCKER_IMAGE_TAG} \
        ui-service=${REGISTRY}/ui-service:${DOCKER_IMAGE_TAG} \
        document-processing-service=${REGISTRY}/document-processing-service:${DOCKER_IMAGE_TAG} \
        ai-requirements-service=${REGISTRY}/ai-requirements-service:${DOCKER_IMAGE_TAG} \
        ai-tasks-service=${REGISTRY}/ai-tasks-service:${DOCKER_IMAGE_TAG} \
        gitlab-client-service=${REGISTRY}/gitlab-client-service:${DOCKER_IMAGE_TAG} \
        mock-auth-service=${REGISTRY}/mock-auth-service:${DOCKER_IMAGE_TAG} \
        neo4j-baked=${REGISTRY}/neo4j-baked:${DOCKER_IMAGE_TAG}
      
      # Build and apply with variable substitution
      kustomize build . | \
        sed "s|\${ENVIRONMENT}|${ENVIRONMENT}|g" | \
        sed "s|\${WORKLOAD_IDENTITY_CLIENT_ID}|${WORKLOAD_IDENTITY_CLIENT_ID}|g" | \
        sed "s|\${APP_CONFIG_NAME}|${APP_CONFIG_NAME}|g" | \
        sed "s|\${REDIS_HOST}|${REDIS_HOST}|g" | \
        sed "s|\${OAI_ENDPOINT}|${OAI_ENDPOINT}|g" | \
        sed "s|\${STORAGE_BLOB_ENDPOINT}|${STORAGE_BLOB_ENDPOINT}|g" | \
        sed "s|\${KEY_VAULT_NAME}|${KEY_VAULT_NAME}|g" | \
        sed "s|\${AZURE_TENANT_ID}|${AZURE_TENANT_ID}|g" | \
        sed "s|\${AZURE_CLIENT_ID}|${AAD_CLIENT_ID}|g" | \
        sed "s|\${GITLAB_BASE_URL}|${GITLAB_BASE_URL:-https://gitlab.com}|g" | \
        kubectl apply -f -
      
      # Wait for deployments to be ready
      echo "Waiting for deployments to be ready..."
      kubectl rollout status deployment -n agentic-ai --timeout=600s || true
      
      echo "Application deployment completed"
  needs:
    - job: infrastructure:deploy
      optional: true
    - build:db-init-service
    - build:project-management-service
    # neo4j_maintanance_service removed (replaced by neo4j_repository_service)
    - build:neo4j-ingestion-service
    - build:neo4j-retrieval-service
    - build:ui-service
    - build:document-processing-service
    - build:ai-requirements-service
    - build:ai-tasks-service
    - build:gitlab-client-service
    - build:mock-auth-service
    - build:neo4j-baked
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  environment:
    name: $ENVIRONMENT
    action: start

# =============================================================================
# VERIFY STAGE
# =============================================================================

verify:health-check:
  stage: verify
  image: mcr.microsoft.com/azure-cli:latest
  <<: *azure_cli_setup
  script:
    - |
      RESOURCE_GROUP="agentic-ai-${ENVIRONMENT}-rg"
      AKS_CLUSTER=$(az deployment sub show --name "agentic-ai-${ENVIRONMENT}" --query "properties.outputs.aksClusterName.value" -o tsv)
      
      az aks install-cli
      az aks get-credentials --resource-group $RESOURCE_GROUP --name $AKS_CLUSTER --overwrite-existing
      
      # Check all pods are running
      echo "Checking pod status..."
      kubectl get pods -n agentic-ai
      
      # Health check for key services
      SERVICES="db-init-service project-management-service ui-service neo4j-retrieval-service"
      for svc in $SERVICES; do
        echo "Checking $svc..."
        kubectl exec -n agentic-ai deploy/$svc -- curl -sf http://localhost:8000/health || echo "Warning: $svc health check failed"
      done
      
      echo "Health checks completed"
  needs:
    - deploy:application
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: delayed
      start_in: 2 minutes
  environment:
    name: $ENVIRONMENT
    action: verify

verify:e2e-tests:
  stage: verify
  image: mcr.microsoft.com/azure-cli:latest
  <<: *azure_cli_setup
  script:
    - |
      apt-get update && apt-get install -y python3 python3-pip
      pip install -e ./e2e_tests
      
      RESOURCE_GROUP="agentic-ai-${ENVIRONMENT}-rg"
      AKS_CLUSTER=$(az deployment sub show --name "agentic-ai-${ENVIRONMENT}" --query "properties.outputs.aksClusterName.value" -o tsv)
      
      az aks install-cli
      az aks get-credentials --resource-group $RESOURCE_GROUP --name $AKS_CLUSTER --overwrite-existing
      
      # Get ingress external IP (ui-service handles routing)
      INGRESS_IP=$(kubectl get svc -n ingress-nginx nginx-ingress-ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
      BASE_URL="http://${INGRESS_IP}"
      
      # All requests go through ui-service which proxies to backend services
      export PROJECT_MANAGEMENT_SERVICE_URL="${BASE_URL}/api/projects"
      export DOCUMENT_PROCESSING_URL="${BASE_URL}/api/documents"
      export AI_REQUIREMENTS_SERVICE_URL="${BASE_URL}/api/ai/requirements"
      export AI_TASKS_SERVICE_URL="${BASE_URL}/api/ai/tasks"
      export UI_SERVICE_URL="${BASE_URL}"
      
      echo "Running E2E tests against ${BASE_URL}..."
      cd e2e_tests
      python3 -m pytest src/ -v --tb=short -x || echo "Some E2E tests failed"
  needs:
    - verify:health-check
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: true
  environment:
    name: $ENVIRONMENT
    action: verify
