apiVersion: batch/v1
kind: Job
metadata:
  name: neo4j-schema-init
  namespace: agentic-ai
  labels:
    app: neo4j-schema-init
    component: init
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: neo4j-schema-init
        azure.workload.identity/use: "true"
    spec:
      serviceAccountName: agentic-ai-workload-identity
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-neo4j-maintenance
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for neo4j-maintanance-service to be ready..."
              until curl -sf http://neo4j-maintanance-service:80/health; do
                echo "Waiting..."
                sleep 5
              done
              echo "neo4j-maintanance-service is ready"
      containers:
        - name: schema-init
          image: python:3.13-slim
          env:
            - name: LOCAL_JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: agentic-ai-secrets
                  key: LOCAL_JWT_SECRET
          volumeMounts:
            - name: secrets-store
              mountPath: "/mnt/secrets-store"
              readOnly: true
          command:
            - python
            - -c
            - |
              import os,time,json,hmac,hashlib,base64,urllib.request
              secret=os.environ.get('LOCAL_JWT_SECRET','')
              if not secret: raise SystemExit('LOCAL_JWT_SECRET not set')
              header={'alg':'HS256','typ':'JWT'}
              payload={'oid': 'system', 'preferred_username': 'system@azure', 'roles': [], 'iat': int(time.time()), 'exp': int(time.time())+600}
              def b64url(d): return base64.urlsafe_b64encode(d).rstrip(b'=')
              seg=b'.'.join([b64url(json.dumps(header,separators=(',',':')).encode()), b64url(json.dumps(payload,separators=(',',':')).encode())])
              sig=b64url(hmac.new(secret.encode(), seg, hashlib.sha256).digest())
              token=(seg+b'.'+sig).decode()
              req=urllib.request.Request('http://neo4j-maintanance-service:80/init-neo4j', data=b'', method='POST', headers={'Authorization': f'Bearer {token}'})
              print('POST /init-neo4j with Authorization header')
              with urllib.request.urlopen(req, timeout=120) as resp:
                  print(resp.status, resp.read().decode())
      volumes:
        - name: secrets-store
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: agentic-ai-secrets


